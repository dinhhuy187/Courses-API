<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chat Real-time</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status.connected {
            background: #10b981;
            color: white;
        }

        .status.disconnected {
            background: #ef4444;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .login-form,
        .conversation-form {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .conversations-list {
            margin-top: 20px;
        }

        .conversation-item {
            padding: 12px;
            background: #f3f4f6;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .conversation-item:hover {
            background: #e5e7eb;
        }

        .conversation-item.active {
            background: #667eea;
            color: white;
        }

        .conversation-item h4 {
            margin-bottom: 5px;
        }

        .conversation-item p {
            font-size: 12px;
            opacity: 0.8;
        }

        .chat-area {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
        }

        .chat-header {
            padding: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .chat-header h2 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 14px;
            color: #6b7280;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
        }

        .message {
            display: flex;
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 60%;
            padding: 12px 16px;
            border-radius: 15px;
            word-wrap: break-word;
        }

        .message.received .message-content {
            background: #e5e7eb;
            color: #1f2937;
        }

        .message.sent .message-content {
            background: #667eea;
            color: white;
        }

        .message-meta {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.7;
        }

        .typing-indicator {
            padding: 10px 20px;
            font-size: 14px;
            color: #6b7280;
            font-style: italic;
        }

        .chat-input {
            padding: 20px;
            border-top: 2px solid #e5e7eb;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .input-container input {
            flex: 1;
            margin-bottom: 0;
        }

        .input-container button {
            width: auto;
            padding: 12px 30px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
        }

        .section-title {
            color: #374151;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .info-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Test Chat Real-time v·ªõi SignalR</h1>
            <span class="status disconnected" id="connectionStatus">Ch∆∞a k·∫øt n·ªëi</span>
        </div>

        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Login Form -->
                <div class="login-form" id="loginForm">
                    <div class="section-title">ƒêƒÉng nh·∫≠p</div>
                    <div class="form-group">
                        <label>User ID (s·ªë nguy√™n)</label>
                        <input type="number" id="userId" placeholder="V√≠ d·ª•: 1">
                    </div>
                    <div class="form-group">
                        <label>T√™n hi·ªÉn th·ªã</label>
                        <input type="text" id="userName" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
                    </div>
                    <div class="form-group">
                        <label>Token (n·∫øu c√≥)</label>
                        <input type="text" id="accessToken" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥">
                    </div>
                    <div class="form-group">
                        <label>API URL</label>
                        <input type="text" id="apiUrl" value="http://localhost:5230"
                            placeholder="http://localhost:5230">
                    </div>
                    <button onclick="connect()">K·∫øt n·ªëi</button>
                    <p class="info-text">üí° M·ªü 2 tab v·ªõi 2 User ID kh√°c nhau ƒë·ªÉ test chat</p>
                </div>

                <!-- Conversation Form -->
                <div class="conversation-form" id="conversationForm" style="display: none;">
                    <div class="section-title">T·∫°o/M·ªü h·ªôi tho·∫°i</div>
                    <div class="form-group">
                        <label>Course ID</label>
                        <input type="number" id="courseId" placeholder="V√≠ d·ª•: 1">
                    </div>
                    <div class="form-group">
                        <label>Seller ID (ng∆∞·ªùi b√°n)</label>
                        <input type="number" id="sellerId" placeholder="V√≠ d·ª•: 2">
                    </div>
                    <button onclick="createConversation()">M·ªü h·ªôi tho·∫°i</button>
                    <p class="info-text">üí° Buyer v√† Seller ph·∫£i l√† 2 user kh√°c nhau</p>
                </div>

                <!-- Conversations List -->
                <div class="conversations-list" id="conversationsList" style="display: none;">
                    <div class="section-title">Danh s√°ch h·ªôi tho·∫°i</div>
                    <div id="conversationsContainer"></div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="empty-state" id="emptyState">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                        </path>
                    </svg>
                    <h3>Ch∆∞a c√≥ h·ªôi tho·∫°i n√†o</h3>
                    <p>Vui l√≤ng t·∫°o ho·∫∑c ch·ªçn m·ªôt h·ªôi tho·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</p>
                </div>

                <div id="chatContainer" style="display: none; height: 100%; display: flex; flex-direction: column;">
                    <div class="chat-header">
                        <h2 id="chatTitle">H·ªôi tho·∫°i</h2>
                        <p id="chatInfo">Conversation ID: -</p>
                    </div>
                    <div class="messages-container" id="messagesContainer"></div>
                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        ƒêang g√µ...
                    </div>
                    <div class="chat-input">
                        <div class="input-container">
                            <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..."
                                onkeypress="handleKeyPress(event)">
                            <button onclick="sendMessage()">G·ª≠i</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentUserId = null;
        let currentUserName = null;
        let currentConversationId = null;
        let apiBaseUrl = 'http://localhost:5230';
        let token = '';
        let typingTimeout = null;

        // K·∫øt n·ªëi SignalR - FIX AUTHENTICATION
        async function connect() {
            const userIdInput = document.getElementById('userId').value;
            const userNameInput = document.getElementById('userName').value;
            const tokenInput = document.getElementById('accessToken').value;
            const apiUrlInput = document.getElementById('apiUrl').value;

            if (!userIdInput || !userNameInput) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            currentUserId = parseInt(userIdInput);
            currentUserName = userNameInput;
            token = tokenInput;
            apiBaseUrl = apiUrlInput;

            try {
                // T·∫°o SignalR connection v·ªõi c·∫•u h√¨nh ƒë√∫ng
                const hubUrl = `${apiBaseUrl}/chathub`;

                const options = {
                    skipNegotiation: true,
                    transport: signalR.HttpTransportType.WebSockets
                };

                // N·∫øu c√≥ token, truy·ªÅn qua accessTokenFactory (chu·∫©n SignalR)    
                if (token && token.trim() !== '') {
                    options.accessTokenFactory = () => token;
                }

                connection = new signalR.HubConnectionBuilder()
                    .withUrl(hubUrl, options)
                    .withAutomaticReconnect()
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                // Setup reconnection handlers
                setupReconnectionHandlers();

                // Event handler - TH√äM LOG
                connection.on("ReceiveMessage", (message) => {
                    console.log('üì© Nh·∫≠n tin nh·∫Øn:', message);
                    console.log('üë§ Current user:', currentUserId);
                    console.log('üì§ Sender:', message.senderId);
                    console.log('üéØ IsSentByCurrentUser:', message.isSentByCurrentUser); // ‚≠ê CHECK GI√Å TR·ªä N√ÄY
                    addMessageToUI(message);
                });

                connection.on("UserTypingStatus", (userId, isTyping) => {
                    showTypingIndicator(isTyping);
                });

                connection.on("NewMessageNotification", (data) => {
                    console.log("üì¨ New message notification:", data);
                });

                connection.on("MessagesMarkedAsRead", (userId, conversationId) => {
                    console.log("‚úÖ Messages marked as read:", userId, conversationId);
                });

                // K·∫øt n·ªëi
                console.log('üîÑ ƒêang k·∫øt n·ªëi SignalR...');
                await connection.start();
                console.log("‚úÖ SignalR Connected!");

                // Update UI
                document.getElementById('connectionStatus').textContent = 'ƒê√£ k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status connected';
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('conversationForm').style.display = 'block';

                // Load conversations
                await loadConversations();

            } catch (error) {
                console.error("‚ùå Connection error:", error);
                document.getElementById('connectionStatus').textContent = 'L·ªói k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status disconnected';

                let errorMsg = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi!\n\n';

                if (error.message.includes('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng')) {
                    errorMsg += '‚ö†Ô∏è L·ªñI X√ÅC TH·ª∞C:\n';
                    errorMsg += '- Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n\n';
                    errorMsg += '- Backend y√™u c·∫ßu token JWT h·ª£p l·ªá\n';
                    errorMsg += '- Ho·∫∑c backend ch∆∞a config CORS cho WebSocket\n\n';
                    errorMsg += 'üí° Gi·∫£i ph√°p:\n';
                    errorMsg += '1. ƒêƒÉng nh·∫≠p ƒë·ªÉ l·∫•y token m·ªõi\n';
                    errorMsg += '2. Ho·∫∑c ƒë·ªÉ tr·ªëng token n·∫øu backend kh√¥ng y√™u c·∫ßu auth\n';
                    errorMsg += '3. Ho·∫∑c backend c·∫ßn s·ª≠a OnConnectedAsync() ƒë·ªÉ cho ph√©p test';
                } else {
                    errorMsg += 'Ki·ªÉm tra:\n';
                    errorMsg += '1. Backend ƒë√£ ch·∫°y ch∆∞a?\n';
                    errorMsg += '2. URL ƒë√∫ng ch∆∞a?\n';
                    errorMsg += '3. Hub path: /chathub';
                }

                errorMsg += '\n\nL·ªói chi ti·∫øt: ' + error.message;

                alert(errorMsg);
            }
        }

        // Reconnection handlers - C·∫¨P NH·∫¨T
        function setupReconnectionHandlers() {
            if (!connection) return;

            connection.onreconnecting(error => {
                console.warn("üîÑ SignalR reconnecting...", error);
                document.getElementById('connectionStatus').textContent = 'ƒêang k·∫øt n·ªëi l·∫°i...';
                document.getElementById('connectionStatus').className = 'status disconnected';
            });

            connection.onreconnected(connectionId => {
                console.log("‚úÖ SignalR reconnected!", connectionId);
                document.getElementById('connectionStatus').textContent = 'ƒê√£ k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status connected';

                // Rejoin conversation hi·ªán t·∫°i n·∫øu c√≥
                if (currentConversationId) {
                    connection.invoke("JoinConversation", currentConversationId)
                        .then(() => console.log("‚úÖ Rejoined conversation"))
                        .catch(err => console.error("‚ùå Rejoin error:", err));
                }
            });

            connection.onclose(error => {
                console.error("‚ùå SignalR connection closed", error);
                document.getElementById('connectionStatus').textContent = 'M·∫•t k·∫øt n·ªëi';
                document.getElementById('connectionStatus').className = 'status disconnected';
            });
        }

        // Load danh s√°ch conversations
        async function loadConversations() {
            try {
                const response = await fetch(`${apiBaseUrl}/api/chat/conversations`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const conversations = await response.json();
                    displayConversations(conversations);
                } else {
                    console.error("Load conversations failed:", await response.text());
                }
            } catch (error) {
                console.error("Load conversations error:", error);
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch conversations
        function displayConversations(conversations) {
            const container = document.getElementById('conversationsContainer');
            container.innerHTML = '';

            if (conversations.length === 0) {
                container.innerHTML = '<p class="info-text">Ch∆∞a c√≥ h·ªôi tho·∫°i n√†o</p>';
                return;
            }

            document.getElementById('conversationsList').style.display = 'block';

            conversations.forEach(conv => {
                const div = document.createElement('div');
                div.className = 'conversation-item';
                div.onclick = () => openConversation(conv.id);

                const otherUser = conv.buyerId === currentUserId ? conv.sellerName : conv.buyerName;

                div.innerHTML = `
                    <h4>üìö ${conv.courseTitle}</h4>
                    <p>üë§ ${otherUser}</p>
                    ${conv.lastMessage ? `<p>üí¨ ${conv.lastMessage.content}</p>` : ''}
                `;
                container.appendChild(div);
            });
        }

        // T·∫°o conversation m·ªõi - GI·ªÆ NGUY√äN NH∆ØNG C·∫¢I THI·ªÜN LOG
        async function createConversation() {
            const courseId = parseInt(document.getElementById('courseId').value);
            const sellerId = parseInt(document.getElementById('sellerId').value);

            if (!courseId || !sellerId) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            if (currentUserId === sellerId) {
                alert('Buyer v√† Seller ph·∫£i kh√°c nhau!');
                return;
            }

            // KI·ªÇM TRA connection
            if (!connection) {
                alert('‚ö†Ô∏è SignalR ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                return;
            }

            if (connection.state !== signalR.HubConnectionState.Connected) {
                alert('‚ö†Ô∏è SignalR ch∆∞a k·∫øt n·ªëi! Tr·∫°ng th√°i: ' + connection.state + '\n\nVui l√≤ng ƒë·ª£i k·∫øt n·ªëi ho√†n t·∫•t ho·∫∑c th·ª≠ k·∫øt n·ªëi l·∫°i.');
                return;
            }

            console.log('üìù Creating conversation...', { courseId, sellerId, currentUserId });

            try {
                const response = await fetch(`${apiBaseUrl}/api/chat/conversations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ courseId, sellerId })
                });

                if (response.ok) {
                    const conversation = await response.json();
                    console.log("‚úÖ Conversation created/retrieved:", conversation);

                    await loadConversations();
                    await openConversation(conversation.id);
                } else {
                    const error = await response.json();
                    alert('‚ùå L·ªói: ' + (error.message || 'Kh√¥ng th·ªÉ t·∫°o h·ªôi tho·∫°i'));
                }
            } catch (error) {
                console.error("‚ùå Create conversation error:", error);
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // M·ªü conversation - CH·ªú CONNECTION S·∫¥N S√ÄNG
        async function openConversation(conversationId) {
            try {
                // Ki·ªÉm tra connection
                if (!connection) {
                    alert('‚ö†Ô∏è SignalR ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    return;
                }

                // ƒê·ª£i connection s·∫µn s√†ng (c√≥ th·ªÉ ƒëang reconnect)
                let retries = 0;
                const maxRetries = 10; // 5 gi√¢y
                while (connection.state !== signalR.HubConnectionState.Connected && retries < maxRetries) {
                    console.log(`‚è≥ ƒê·ª£i connection... (${retries + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retries++;
                }

                if (connection.state !== signalR.HubConnectionState.Connected) {
                    console.log('‚ùå SignalR not connected, attempting to reconnect...');
                    try {
                        await connection.start();
                        console.log('‚úÖ Reconnected successfully!');
                    } catch (reconnectError) {
                        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi l·∫°i SignalR. Vui l√≤ng refresh trang v√† ƒëƒÉng nh·∫≠p l·∫°i.\n\n' + reconnectError.message);
                        return;
                    }
                }

                // Leave conversation c≈©
                if (currentConversationId && currentConversationId !== conversationId) {
                    try {
                        await connection.invoke("LeaveConversation", currentConversationId);
                    } catch (err) {
                        console.warn("‚ö†Ô∏è Leave conversation error (ignored):", err);
                    }
                }

                currentConversationId = conversationId;

                // Load messages
                const response = await fetch(
                    `${apiBaseUrl}/api/chat/conversations/${conversationId}/messages`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                if (response.ok) {
                    const messages = await response.json();
                    displayMessages(messages);

                    // Update UI
                    document.getElementById('emptyState').style.display = 'none';
                    document.getElementById('chatContainer').style.display = 'flex';
                    document.getElementById('chatTitle').textContent = `H·ªôi tho·∫°i #${conversationId}`;
                    document.getElementById('chatInfo').textContent = `Conversation ID: ${conversationId}`;

                    // Mark active conversation
                    document.querySelectorAll('.conversation-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    event?.target?.closest('.conversation-item')?.classList.add('active');

                    // Join conversation
                    console.log(`üîó Joining conversation ${conversationId}...`);
                    await connection.invoke("JoinConversation", conversationId);
                    console.log(`‚úÖ Joined conversation ${conversationId}`);
                } else {
                    const error = await response.text();
                    alert('Kh√¥ng th·ªÉ load tin nh·∫Øn: ' + error);
                }
            } catch (error) {
                console.error("‚ùå Open conversation error:", error);
                alert('L·ªói: ' + error.message);
            }
        }
        // Hi·ªÉn th·ªã messages
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            messages.forEach(msg => {
                addMessageToUI(msg);
            });

            scrollToBottom();
        }

        // Th√™m message v√†o UI
        // S·ª≠a h√†m addMessageToUI
        function addMessageToUI(message) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');

            // ‚≠ê FRONTEND T·ª∞ T√çNH - So s√°nh senderId v·ªõi currentUserId
            const isSentByMe = message.senderId === currentUserId;

            console.log(`Message from ${message.senderId}, current user: ${currentUserId}, isSentByMe: ${isSentByMe}`);

            div.className = `message ${isSentByMe ? 'sent' : 'received'}`;

            const time = new Date(message.createdAt).toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            div.innerHTML = `
        <div class="message-content">
            ${!isSentByMe ? `<strong>${message.senderName}</strong><br>` : ''}
            ${message.content}
            <div class="message-meta">${time}</div>
        </div>
    `;

            container.appendChild(div);
            scrollToBottom();
        }

        // G·ª≠i message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentConversationId) return;

            // Ki·ªÉm tra connection
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                alert('M·∫•t k·∫øt n·ªëi! ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...');
                try {
                    await connection.start();
                    console.log('Reconnected!');
                } catch (err) {
                    alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi l·∫°i. Vui l√≤ng refresh trang.');
                    return;
                }
            }

            try {
                await connection.invoke("SendMessage", {
                    conversationId: currentConversationId,
                    content: content
                });

                input.value = '';
            } catch (error) {
                console.error("Send message error:", error);
                alert('L·ªói g·ª≠i tin nh·∫Øn: ' + error.message);
            }
        }

        // Handle typing
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
                return;
            }

            // Send typing indicator
            if (connection &&
                currentConversationId &&
                connection.state === signalR.HubConnectionState.Connected) {
                try {
                    connection.invoke("UserTyping", currentConversationId, true)
                        .catch(err => console.warn("Typing error:", err));

                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        connection.invoke("UserTyping", currentConversationId, false)
                            .catch(err => console.warn("Typing error:", err));
                    }, 2000);
                } catch (err) {
                    console.warn("Typing indicator error:", err);
                }
            }
        }

        // Show typing indicator
        function showTypingIndicator(isTyping) {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = isTyping ? 'block' : 'none';
        }

        // Scroll to bottom
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Handle connection close
        window.addEventListener('beforeunload', () => {
            if (connection) {
                connection.stop();
            }
        });
    </script>
</body>

</html>